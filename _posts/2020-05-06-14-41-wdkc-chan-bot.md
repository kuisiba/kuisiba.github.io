---
layout: post
title: 和同開珎を出題するSlack Botを作った
date: 2020-05-06-14-41
---

![和同開珎](/assets/wdkc20200506.png)

こういう穴埋めクイズを *和同開珎* というらしい。
Webを漁れば色々と問題が転がっている。

GW中暇だったので、こういう問題を沢山生成して、Slackに投稿するBotを作って会社のSlackチャンネルに放流した。
まだ放流して2日目だけど、毎朝10時〜11時の間に1問投稿するようにしている。

## 難易度設定
会社のSlackに毎朝投稿する都合上、*毎朝数分の頭のエクササイズ*的な難易度が望ましい。
よって、4つの二字熟語も、それを構成する漢字もなるべく簡単な方が良い。
そこで、漢字については文科省が公開している[別表 学年別漢字配当表](https://www.mext.go.jp/a_menu/shotou/new-cs/youryou/syo/koku/001.htm)のみに絞った。

小学生の間に習う漢字は1006文字で、それらのみを用いて作れる二字熟語は手元で簡単に調べた結果25000個程度、らしい。

## 熟語リスト
Wikipediaのダンプファイルで、タイトルとabstractのみのxmlが公開されており、それをダウンロードしてきて解凍。約1.8GB。結構でかい。

こいつをBeautifulSoupとか正規表現とかを駆使して不要なマークアップ部分などを削ぎ落とす。これで151MB。

この151MBのテキストから、上記の約25000個の熟語の出現回数を調べる。

出現回数が1000回を超える熟語＝簡単でみんな知ってる熟語だろうと勝手に決めつけてそれらをリストアップ。1100個くらい。

`"子": ["分子", "子供", "王子", "原子", "男子", "量子", "女子", "息子", "電子"]` のように単語ごとにグループわけ。

## 問題の画像生成とそれを置く場所
グループ分けされた熟語のリストからランダムに4個抜いてきて、隠すべき共通部分を隠してjpg画像として出力。pillowというライブラリを使ったんだけどあっさり出来た。

とりあえず200個ほど問題を生成した。後述する問題があったので、S3に放り投げた。

## Botの設定
SlackのアプリとかAPIとかのページでぽちぽち設定して、トークンの発行などを行った。
`Slack bot token` とかでぐぐれば情報はいくらでも出てくる。

## GAS書くよ
最初、Google Driveに問題画像を置いてGASでそれを取得してSlackに投稿、という流れにしようと思ったのだけど、Google Drive上のファイルをGASから取得する方法がわからず難儀した。
公式のマニュアルやリファレンス見てもわからんし、個人ブログなどを漁っても思わしい情報が出てこず。
いや絶対方法あるはずやろ・・・と思って粘った結果ここで数時間溶けた。

結局S3に問題ファイルを置いてそれを引っ張ってくる形に。実装2分くらいで終わった。

あとは、GASのトリガーで毎朝10時〜11時にSlackに画像ファイルをuploadする関数を実行するよう設定してあげるだけで終わり。

これLambdaとCloudWatch eventsでやっても良かったんだけど、最悪動かなくても誰も困らないし、詳細なログなども必要ないのでまあGASで良いかなと。

## fbもらった
上下左右の二字熟語の表示順。

日本人は左から右へ、上から下へ読むのに慣れてるから、問題もなるべくそのような順で表示すべきという意見を貰った。
一瞬「確かに・・・」と納得しかけたけど、脳トレ的な意味であべこべでも良いのでは？と思い直した。ので特に直さなくていいかな、と今の所考えている。

## 感想
相当やっつけ仕事だし改善すべき点は山程思いつくけど、取りあえず動く状態に持っていくまでをなるはやでやる、という方針で開発を進めた。
理由は簡単で、飽きるから。ガガッと作らないと「なんでこんなクソ作ってるんだっけ？」という自問自答をしてしまい、完成が遠のいてしまう。
数GBのテキスト処理などで数分の待ち時間が発生することも多々あったので、そういう時は即天鳳をやることで自問自答タイムを発生させないようにした。
結果、6級→3級になった。やりすぎや。

一応[画像生成部のリポジトリ](https://github.com/kuisiba/wdkc)だけ乗っけておく。

### Python
ほぼ書き捨てのようなコードだし、全体の7割くらいはpythonで書いた。
あんまりPythonの使ったことなかったが、楽ちんだし、ライブラリも充実してるしユーザ多いから情報も豊富だしで言うことない。
今回みたいな用途には最適の言語だと感じた。

### Rust
一部、重めの処理はRustで書いた。・・・けど天鳳打ちまくったし結局Pythonで良かったやん・・・とも思った。

### GAS
つい先日V8ランタイムが使われるようになり[参考](https://developers.google.com/apps-script/guides/v8-runtime?hl=ja)モダンな記法も使えるようになった。

が、やはりGASは辛い。

* メンテの必要がなく
* コード全体がコメント等を含めても数十行で収まる

という **絶対の** 確信がない限り使うべきではないと再確認した。
オンラインエディタもクソみたいな挙動するし、デプロイ周りでも謎の挙動をするときがあるなど、人をイラつかせる罠が山程ある。
